const express = require("express");const fs = require("fs");const axios = require("axios");const app = express();app.use(express.json());const STATE_FILE = "./state.json";/* =========================   Hilfsfunktionen========================= */function loadState() {  if (!fs.existsSync(STATE_FILE)) {    return {      alarmState: "OK",      threshold: -1.20,      lastAlarmSource: null,      lastPush: null    };  }  return JSON.parse(fs.readFileSync(STATE_FILE, "utf8"));}function saveState(state) {  fs.writeFileSync(STATE_FILE, JSON.stringify(state, null, 2));}/* =========================   Status abfragen (Frontend)========================= */app.get("/state", (req, res) => {  res.json(loadState());});/* =========================   Alarm vom Frontend========================= */app.post("/alarm", async (req, res) => {  const { currentValue, threshold, source } = req.body;  const state = loadState();  state.threshold = threshold;  const isAlarm = currentValue >= threshold;  // Übergang OK ? ALARM  if (state.alarmState === "OK" && isAlarm) {    state.alarmState = "ALARM";    state.lastAlarmSource = source;    // NUR Messwert triggert Push    if (source === "MEASUREMENT") {      await sendPush(currentValue, threshold);      state.lastPush = new Date().toISOString();    }  }  // Rückkehr ALARM ? OK  if (state.alarmState === "ALARM" && !isAlarm) {    state.alarmState = "OK";    state.lastAlarmSource = null;  }  saveState(state);  res.json({ ok: true, state });});/* =========================   Pushover========================= */async function sendPush(value, threshold) {  const PUSHOVER_TOKEN = "ahyxj14q7whvdzfbw4zrar663emb23";  const PUSHOVER_USER  = "u2wmcddmi1xmombjpwgnbqqsbekvj4";  try {    await axios.post("https://api.pushover.net/1/messages.json", {      token: PUSHOVER_TOKEN,      user: PUSHOVER_USER,      title: "Grundwasser Alarm",      message:        `Alarm ausgelöst!\n` +        `Messwert: ${Math.abs(value).toFixed(2)} m\n` +        `Alarmwert: ${Math.abs(threshold).toFixed(2)} m`,      priority: 1    });    console.log("Push gesendet");  } catch (err) {    console.error("Push Fehler:", err.response?.data || err.message);  }}/* =========================   Server starten========================= */app.listen(3000, () => {  console.log("Alarm-Server läuft auf http://localhost:3000");});