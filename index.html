<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#b00000">
  
<title>Grundwasserstand - Alarmmonitor</title>

<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 12px;
}
h2 { margin-bottom: 6px; }

/* Upload */
.file-upload {
  display: inline-flex;
  padding: 6px 10px;
  border: 1px dashed #bbb;
  border-radius: 6px;
  cursor: pointer;
  margin-bottom: 8px;
}
.file-upload input { display: none; }

/* Toolbar */
.toolbar {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
  margin-bottom: 8px;
}
.toolbar button {
  padding: 6px 10px;
  border: 1px solid #ccc;
  border-radius: 4px;
  background: #f5f5f5;
  cursor: pointer;
}
.toolbar button.active {
  background: #775DD0;
  color: #fff;
}
.mute-toggle {
  display: flex;
  align-items: center;
  gap: 4px;
  font-size: 0.9em;
}

/* Status */
.status {
  padding: 8px 12px;
  border-radius: 6px;
  font-weight: bold;
  margin-bottom: 8px;
}
.status.ok {
  background: #e6f6ea;
  color: #1e7f3f;
}
.status.alarm {
  background: #ffe5e5;
  color: #b00000;
  animation: pulseText 1.5s infinite;
}
@keyframes pulseText {
  0% { opacity: 1; }
  50% { opacity: 0.65; }
  100% { opacity: 1; }
}

/* Layout */
.layout {
  display: flex;
  width: 100%;
}
#chart {
  flex: 1;
  min-height: 360px;
}

/* Slider */
.slider-container {
  width: 64px;
  position: relative;
  display: flex;
  justify-content: center;
}

input[type=range].vertical {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 360px;
  transform: translate(-50%, -50%) rotate(-90deg);
  background: transparent;
}

/* ===== Slider SCHIENE ===== */
.slider-ok input::-moz-range-track {
  height: 8px;
  background: #b7e1c1;
  border-radius: 4px;
}

.slider-alarm input::-moz-range-track {
  height: 8px;
  background: #f3b3b3;
  border-radius: 4px;
}

/* ===== Slider THUMB ===== */
.slider-ok input::-moz-range-thumb {
  width: 26px;
  height: 26px;
  background: #1e7f3f;
  border: 2px solid #155c2d;
  border-radius: 50%;
  cursor: grab;
}

.slider-alarm input::-moz-range-thumb {
  width: 26px;
  height: 26px;
  background: red;
  border: 2px solid darkred;
  border-radius: 50%;
  cursor: grab;
  animation: alarmPulse 1.6s infinite;
}

input[type=range]:active::-moz-range-thumb {
  cursor: grabbing;
}

@keyframes alarmPulse {
  0% { box-shadow: 0 0 0 0 rgba(255,0,0,0.6); }
  70% { box-shadow: 0 0 0 10px rgba(255,0,0,0); }
  100% { box-shadow: 0 0 0 0 rgba(255,0,0,0); }
}

/* Slider Value */
.slider-value {
  position: absolute;
  bottom: -32px;
  width: 100%;
  text-align: center;
  font-weight: bold;
}
</style>
</head>

<body>

<h2>Grundwasserstand (0 = GOK)</h2>

<label class="file-upload">
  <span id="uploadText">Select .txt File</span>
  <input type="file" id="fileInput" accept=".txt">
</label>

<div class="toolbar">
  <button data-range="1w">1W</button>
  <button data-range="1m">1M</button>
  <button data-range="1y">1Y</button>
  <button data-range="ytd">YTD</button>
  <button data-range="all" class="active">Alle</button>

  <label class="mute-toggle">
    <input type="checkbox" id="muteToggle"> Alarmton stumm
  </label>
</div>

<div id="alarmStatus" class="status ok">
  Status: OK - alles im gruenen Bereich
</div>

<div class="layout">
  <div id="chart"></div>

  <div class="slider-container slider-ok">
    <input type="range" id="thresholdSlider" class="vertical" step="0.01">
    <div class="slider-value">
      <span id="sliderValue">-</span> m
    </div>
  </div>
</div>

<audio id="alarmSound" loop>
  <source src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg">
</audio>

<script>
let chart;
let thresholdY = -1.20;
let lastValue = null;
let alarmState = "OK";

let minY, maxY, paddedMinY;
let fullMinX, fullMaxX;

const alarmSound = document.getElementById("alarmSound");
let soundEnabled = true;

/* Upload */
fileInput.onchange = e => {
  const file = e.target.files[0];
  if (!file) return;
  uploadText.textContent = file.name;
  const r = new FileReader();
  r.onload = () => parseTxt(r.result);
  r.readAsText(file);
};

function parseTxt(text) {
  const data = [];

  text.split(/\r?\n/).forEach(line => {
    if (!/^\d{2}\.\d{2}\.\d{4}/.test(line)) return;
    const p = line.trim().split(/\s+/);
    const [d,m,y] = p[0].split(".");
    const x = new Date(`${y}-${m}-${d}T${p[1]}`).getTime();
    const yVal = -parseFloat(p[2].replace(",", "."));
    if (!isNaN(x) && !isNaN(yVal)) data.push([x,yVal]);
  });

  data.sort((a,b)=>a[0]-b[0]);

  fullMinX = data[0][0];
  fullMaxX = data[data.length-1][0];

  minY = Math.min(...data.map(d=>d[1]));
  maxY = Math.max(...data.map(d=>d[1]));
  paddedMinY = minY - (maxY-minY)*0.1;

  lastValue = data[data.length-1][1];

  setupSlider();
  renderChart(data);
  updateSliderColor();
  checkAlarm();
}

/* Slider */
function setupSlider() {
  thresholdSlider.min = minY;
  thresholdSlider.max = 0;
  thresholdSlider.value = thresholdY;
  updateSliderLabel();

  thresholdSlider.oninput = () => {
    thresholdY = parseFloat(thresholdSlider.value);
    updateSliderLabel();
    refreshChartVisuals();
    updateSliderColor();
    checkAlarm();
  };
}

function updateSliderLabel() {
  sliderValue.textContent = Math.abs(thresholdY).toFixed(2);
}

function updateSliderColor() {
  const c = document.querySelector(".slider-container");
  c.classList.toggle("slider-alarm", thresholdY <= lastValue);
  c.classList.toggle("slider-ok", thresholdY > lastValue);
}

/* Alarm */
function checkAlarm() {
  if (lastValue === null) return;

  if (alarmState === "OK" && lastValue >= thresholdY) {
    alarmState = "ALARM";
    updateStatus();
    refreshChartVisuals();
    if (soundEnabled) {
      alarmSound.currentTime = 0;
      alarmSound.play().catch(()=>{});
    }
  }

  if (alarmState === "ALARM" && lastValue < thresholdY) {
    alarmState = "OK";
    alarmSound.pause();
    alarmSound.currentTime = 0;
    updateStatus();
    refreshChartVisuals();
  }
}

function updateStatus() {
  if (alarmState === "ALARM") {
    alarmStatus.textContent = "Status: ALARM - Grenzwert unterschritten";
    alarmStatus.className = "status alarm";
  } else {
    alarmStatus.textContent = "Status: OK - alles im gruenen Bereich";
    alarmStatus.className = "status ok";
  }
}

/* Chart */
function renderChart(data) {
  if (chart) chart.destroy();

  chart = new ApexCharts(document.querySelector("#chart"), {
    series: [{
      name:"Grundwasser GOK",
      data
    }],
    chart: {
      type:"line",
      height:"100%",
      zoom:{ enabled:true },
      pan:{ enabled:true, mode:"x" },
      toolbar:{ show:false }
    },
    stroke: {
      width: 2,
      curve: "straight"
    },
    colors: ["#1f77b4"],
    xaxis:{ type:"datetime" },
    yaxis:{
      min:paddedMinY,
      max:0,
      labels:{ formatter:v=>Math.abs(v).toFixed(1) }
    },
    annotations:{ yaxis: buildAnnotations() },
    dataLabels:{ enabled:false },
    markers:{ size:0 }
  });

  chart.render();
}

function buildAnnotations() {
  const isAlarm = lastValue >= thresholdY;
  const color = isAlarm ? "red" : "green";

  return [
    {
      y: thresholdY,
      y2: 0,
      fillColor: isAlarm
        ? "rgba(255,0,0,0.18)"
        : "rgba(0,200,0,0.08)"
    },
    {
      y: thresholdY,
      borderColor: color,
      label: {
        text: "Alarmwert " + Math.abs(thresholdY).toFixed(2) + " m",
        style: { background: color, color: "#fff" }
      }
    }
  ];
}

function refreshChartVisuals() {
  chart.updateOptions({
    annotations:{ yaxis: buildAnnotations() }
  }, false, false);
}

/* Zoom */
document.querySelectorAll(".toolbar button").forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll(".toolbar button")
      .forEach(b => b.classList.remove("active"));
    btn.classList.add("active");

    let start = fullMinX;
    const end = fullMaxX;
    const r = btn.dataset.range;

    if (r === "1w") start = end - 7*86400000;
    if (r === "1m") start = end - 30*86400000;
    if (r === "1y") start = end - 365*86400000;
    if (r === "ytd") {
      const d = new Date(end);
      start = new Date(d.getFullYear(),0,1).getTime();
    }

    chart.zoomX(start, end);
  };
});

/* Mute */
muteToggle.onchange = e => {
  soundEnabled = !e.target.checked;
  if (!soundEnabled) {
    alarmSound.pause();
    alarmSound.currentTime = 0;
  }
};
</script>
  
<script>
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker
      .register("./service-worker.js")
      .then(reg => {
        console.log("Service Worker registriert:", reg.scope);
      })
      .catch(err => {
        console.error("Service Worker Fehler:", err);
      });
  });
}
</script>

<script>
async function requestNotificationPermission() {
  if (!("Notification" in window)) {
    alert("Dieser Browser unterstÃ¼tzt keine Benachrichtigungen.");
    return;
  }

  const permission = await Notification.requestPermission();

  if (permission === "granted") {
    console.log("Push-Benachrichtigungen erlaubt");
  } else {
    alert("Push-Benachrichtigungen wurden abgelehnt.");
  }
}

// Beim ersten Laden anfragen
window.addEventListener("load", () => {
  requestNotificationPermission();
});
</script>
  

</body>
</html>



